image: docker:latest

stages:
  - prepare
  - build

get_version_unstable:
  stage: prepare
  image: ubuntu:18.04
  script:
    - ./get_version.sh unstable
  artifacts:
      paths:
        - jitsi/

get_version_testing:
  stage: prepare
  image: ubuntu:18.04
  script:
    - ./get_version.sh testing
  artifacts:
      paths:
        - jitsi/


get_version_stable:
  stage: prepare
  image: ubuntu:18.04
  script:
    - ./get_version.sh stable
  artifacts:
      paths:
        - jitsi/

checkout:
  stage: prepare
  image: alpine
  script:
    - apk add git
    - mkdir jitsi && cd jitsi
    - git clone https://github.com/jitsi/docker-jitsi-meet.git
  artifacts:
      paths:
        - jitsi/

build_unstable:
  stage: build
  image: docker:dind
  services:
    - docker:dind
  before_script:
    - apk add bash make
    - docker login -u $CI_REGISTRY_USER -p "$CI_REGISTRY_PASSWORD"
  script:
    - ./build.sh unstable

build_testing:
  stage: build
  image: docker:dind
  services:
    - docker:dind
  before_script:
    - apk add bash make
    - docker login -u $CI_REGISTRY_USER -p "$CI_REGISTRY_PASSWORD"
  script:
    - ./build.sh testing

build_stable:
  stage: build
  image: docker:dind
  services:
    - docker:dind
  before_script:
    - apk add bash make
    - docker login -u $CI_REGISTRY_USER -p "$CI_REGISTRY_PASSWORD"
  script:
    - ./build.sh stable
